{% extends 'core/base.html' %}
{% load static %}

{% block title %}Omni-RMM NOC Dashboard{% endblock %}

{% block header %}NOC Dashboard{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch("{% url 'dashboard_chart_data' %}")
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('telemetryChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Avg CPU Usage (%)',
                            data: data.cpu,
                            borderColor: '#00ff9d',
                            backgroundColor: 'rgba(0, 255, 157, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }, {
                            label: 'Avg RAM Usage (%)',
                            data: data.ram,
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#e0e0e0' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#888' }
                            },
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#888' }
                            }
                        }
                    }
                });
            })
            .catch(error => console.error('Error fetching chart data:', error));
    });
</script>
{% endblock %}

{% block content %}
<div class="grid-container">
    <!-- Total Devices -->
    <div class="widget-card">
        <div class="widget-title">Total Devices</div>
        <div class="widget-value">{{ device_count }}</div>
        <div class="widget-footer">
            <span class="accent-dot dot-blue"></span> Monitored Assets
        </div>
    </div>

    <!-- Online Devices -->
    <div class="widget-card">
        <div class="widget-title">Online Devices</div>
        <div class="widget-value" style="color: var(--accent-green); -webkit-text-fill-color: var(--accent-green);">{{ online_count }}</div>
        <div class="widget-footer">
            <span class="accent-dot dot-green"></span> Active Connections
        </div>
    </div>

    <!-- Offline Devices -->
    <div class="widget-card">
        <div class="widget-title">Offline Devices</div>
        <div class="widget-value" style="color: var(--accent-red); -webkit-text-fill-color: var(--accent-red);">{{ offline_count }}</div>
        <div class="widget-footer">
            <span class="accent-dot dot-red"></span> Require Attention
        </div>
    </div>

    <!-- Open Tickets -->
    <div class="widget-card">
        <div class="widget-title">Outstanding Tickets</div>
        <div class="widget-value" style="color: var(--accent-yellow); -webkit-text-fill-color: var(--accent-yellow);">{{ ticket_count }}</div>
        <div class="widget-footer">
            <span class="accent-dot dot-yellow"></span> Pending Resolution
        </div>
    </div>
</div>

<div class="card-panel" style="margin-bottom: 20px;">
    <h3>System Performance (Last 24h)</h3>
    <div style="height: 300px;">
        <canvas id="telemetryChart"></canvas>
    </div>
</div>

<div class="card-panel">
    <h3>Recent Device Activity</h3>
    <table>
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP Address</th>
                <th>OS</th>
                <th>Status</th>
                <th>Last Seen</th>
            </tr>
        </thead>
        <tbody>
            {% for device in recent_devices %}
            <tr>
                <td>{{ device.hostname }}</td>
                <td>{{ device.local_ip }}</td>
                <td>{{ device.os_info }}</td>
                <td class="{% if device.is_online %}status-online{% else %}status-offline{% endif %}">
                    {% if device.is_online %}ONLINE{% else %}OFFLINE{% endif %}
                </td>
                <td>{{ device.last_seen|date:"Y-m-d H:i" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" style="text-align: center; color: #666;">No devices connected yet.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<a href="/api/" class="api-link">API Documentation</a>
{% endblock %}
